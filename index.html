<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/maplibre-contour@0.0.5/dist/index.min.js"></script>

    <style>
           body {
  margin: 0;
}

.container {
	position: relative;
	width: 100vw;
	height: 100vh;
}

.container > div {
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
}

canvas {
  mix-blend-mode: multiply;
}

    </style>
  </head>
  <body>
    <div class="container">
  <div id="mapBase"></div>
  <div id="mapBase2"></div>
  <div id="mapOverlay"></div>
</div>

    <script>
var demSource = new mlcontour.DemSource({
            url: "https://elevation-tiles-prod.s3.amazonaws.com/terrarium/{z}/{x}/{y}.png",
            encoding: "terrarium",
            maxzoom: 13,
            timeoutMs: 10_000, // timeout on fetch requests
        });

        // calls maplibregl.addProtocol for the shared cache and contour protocols
        demSource.setupMaplibre(maplibregl);



const baseStyle = {
  "version": 8,
	"sources": {
    "tilezen": {
			"type": "raster-dem",
			"tiles": ["https://elevation-tiles-prod.s3.amazonaws.com/terrarium/{z}/{x}/{y}.png"],
			"tileSize": 256,
                                   "encoding": "terrarium",
      "attribution": "&copy; Tilezen",
      "maxzoom": 13
    },
"swissmap": {
      "type": "vector",
      "url": "https://wipfli.github.io/swiss-map/tilejson-swissmap.json"
    }
  },
  "layers": [
        {
                    id: "hills",
                type: "hillshade",
                source: "tilezen",
                paint: {
"hillshade-method": "igor",
                    "hillshade-exaggeration": 1,
                    "hillshade-highlight-color": "rgba(255, 255, 228, 1)",
                    "hillshade-shadow-color": "rgb(173, 188, 199)",
                    "hillshade-illumination-direction": 315
                }
            } ]
};

const base2Style = {
  "version": 8,
	"sources": {"swissmap": {
      "type": "vector",
      "url": "https://wipfli.github.io/swiss-map/tilejson-swissmap.json"
    }},
"glyphs": "https://wipfli.github.io/swiss-map/font/{fontstack}/{range}.pbf",
  "layers": [ {
      "id": "wood",
      "type": "fill",
      "source": "swissmap",
      "source-layer": "wood",
      "layout": {
        "visibility": "visible"
      },
      "paint": {
        "fill-color": "rgb(205, 230, 190)"
      }
    },
   {
      "id": "water",
      "type": "fill",
      "source": "swissmap",
      "source-layer": "water",
      "layout": {
        "visibility": "visible"
      },
      "paint": {
        "fill-color": "#abcdfb"
      }
    },]
};
const overlayStyle = {
  "version": 8,
	"sources": {"swissmap": {
      "type": "vector",
      "url": "https://wipfli.github.io/swiss-map/tilejson-swissmap.json"
    }},
  "glyphs": "https://wipfli.github.io/swiss-map/font/{fontstack}/{range}.pbf",
  "layers": []
};


// Initialise the base and overlay maps
const mapBase = new maplibregl.Map({
  container: 'mapBase',
  style: baseStyle,
  center: [8, 47],
  zoom: 10
});

const mapBase2 = new maplibregl.Map({
  container: 'mapBase2',
  style: base2Style,
// style:   'https://wipfli.github.io/swiss-map/style.json',
center: [8, 47],
  zoom: 10
});

const mapOverlay = new maplibregl.Map({
  container: 'mapOverlay',
  style: overlayStyle,
// style:   'https://wipfli.github.io/swiss-map/style.json',
center: [8, 47],
  zoom: 10
});

mapOverlay.on('load', () => {

mapOverlay.addSource("contour-source", {
                type: "vector",
                tiles: [
                    demSource.contourProtocolUrl({
                        thresholds: {
                            // zoom: [minor, major]
                            11: [100, 500],
                            14: [20, 100]
                        },
                        // optional, override vector tile parameters:
                        contourLayer: "contours",
                        elevationKey: "ele",
                        levelKey: "level",
                        extent: 4096,
                        buffer: 1,
                        overzoom: 0,
                    }),
                ],
                maxzoom: 15,
            });
mapOverlay.addLayer({
                id: "contour-lines",
                type: "line",
                source: "contour-source",
                "source-layer": "contours",
                paint: {
                    "line-color": "rgba(215, 151, 060, 1)",
                    // level = highest index in thresholds array the elevation is a multiple of
                    "line-width": ["match", ["get", "level"], 1, 1, .5],
                    "line-opacity": ["step", ["zoom"], 0.6, 12, 0.7, 14, 1.0],
                    
                },
            });

mapOverlay.addLayer({
                id: "contour-labels",
                type: "symbol",
                source: "contour-source",
                "source-layer": "contours",
                filter: [">", ["get", "level"], 0],
                layout: {
                    "symbol-placement": "line",
                    "text-size": 14,
                    "text-field": ['concat', ["number-format", ["get", "ele"], {},], 'm'],
                    "text-font": ["Fira Sans Regular"],
                },
                paint: {
                    "text-color": "rgba(215, 151, 060, 1)",
                    "text-halo-color": "white",
                    "text-halo-width": 5,
                },
            });
           
});

mapOverlay.on('move', () => {
   var zoom = mapOverlay.getZoom();
   var center = mapOverlay.getCenter();
  mapBase.setZoom(zoom);
  mapBase.setCenter(center);
  mapBase2.setZoom(zoom);
  mapBase2.setCenter(center);
});


    </script>
  </body>
</html>

    
